# ======================================================================
#           –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ü–†–ï–û–ë–†–ê–ó–û–í–ê–¢–ï–õ–¨ –û–¢–ß–ï–¢–û–í –ü–û –£–°–ü–ï–í–ê–ï–ú–û–°–¢–ò
# ======================================================================
#
# –ê–≤—Ç–æ—Ä ‚Äî –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –°—É—Ö–æ—Ä—É–∫–æ–≤ –°–µ—Ä–≥–µ–π. –ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º: https://t.me/Namewww
#
# –ß–¢–û –î–ï–õ–ê–ï–¢ –°–ö–†–ò–ü–¢:
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É Excel-–æ—Ç—á–µ—Ç–æ–≤ –ø–æ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ (–Ω–µ CSV, –Ω–µ JSON).
# –û–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –¥–≤—É—Ö —Ä–µ–∂–∏–º–∞—Ö:
#   1. –ê–Ω–∞–ª–∏–∑ –ø–æ—É—Ä–æ—á–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤ (‚Ññ2): –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å "–¥–∑_" –∏–ª–∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏–µ—Å—è –Ω–∞ "_–¥–∑".
#      ‚Äì –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç "–¥–æ–ª–≥–∏" (–Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –î–ó) –∏ –Ω–µ–¥–∞–≤–Ω–æ —Å–¥–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã.
#      ‚Äì –°—á–∏—Ç–∞–µ—Ç —É—Å–ø–µ—à–Ω–æ—Å—Ç—å, —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –¥–ª—è –æ—Ç—á–µ—Ç–∞.
#   2. –ê–Ω–∞–ª–∏–∑ –æ—Ç—á–µ—Ç–æ–≤ —Å –ü–† (‚Ññ4): –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å "–ø—Ä_" –∏–ª–∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏–µ—Å—è –Ω–∞ "_–ø—Ä".
#      ‚Äì –§–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–µ/–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã.
#      ‚Äì –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–¥–æ–ª–≥–∏" –∏ –Ω–µ–¥–∞–≤–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ü–† —Å –æ—Ü–µ–Ω–∫–æ–π –∏ %.
#
# –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –°–ö–†–ò–ü–¢:
#   1. –ü–æ–º–µ—Å—Ç–∏—Ç–µ –∏—Å—Ö–æ–¥–Ω—ã–µ Excel-—Ñ–∞–π–ª—ã (—Å –î–ó –∏/–∏–ª–∏ –ü–†) –≤ –ø–∞–ø–∫—É "–ó–∞–≥—Ä—É–∑–∫–∏" (Downloads).
#   2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç Python-—Å–∫—Ä–∏–ø—Ç.
#   3. –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ—Ç –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
#   4. –í –ø–∞–ø–∫–µ "–ó–∞–≥—Ä—É–∑–∫–∏" –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º "_–û–ë–†–ê–ë–û–¢–ê–ù–ù–´–ô".
#   5. –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—à–ª–∞ –±–µ–∑ –æ—à–∏–±–æ–∫, –∏—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –ö–æ—Ä–∑–∏–Ω—É.
#      –ï—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏, –∏—Å—Ö–æ–¥–Ω–∏–∫–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
#   6. –í –∫–æ–Ω—Å–æ–ª—å –≤—ã–≤–æ–¥–∏—Ç—Å—è —Å–≤–æ–¥–∫–∞ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤ –∏ –æ—à–∏–±–∫–∞–º.
#
# –ü–û–ù–Ø–¢–ò–ï "–ë–£–§–ï–†–ê" –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏ get_analysis_period():
# –ë—É—Ñ–µ—Ä ‚Äî —ç—Ç–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–Ω–µ–π, —Ä–∞—Å—à–∏—Ä—è—é—â–µ–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º–æ–µ –æ–∫–Ω–æ.
# –û–Ω –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã –∑–∞—Ö–≤–∞—Ç–∏—Ç—å —Ä–∞–±–æ—Ç—ã, —Å–¥–∞–Ω–Ω—ã–µ —á—É—Ç—å —Ä–∞–Ω—å—à–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º–æ–π –Ω–µ–¥–µ–ª–∏.
#   * –í –≤—ã—Ö–æ–¥–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —Ç–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è + –±—É—Ñ–µ—Ä (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 2 –¥–Ω—è).
#   * –í –±—É–¥–Ω–∏ ‚Äî –ø—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è –±–µ–∑ –±—É—Ñ–µ—Ä–∞ (0 –¥–Ω–µ–π).
#
# –ù–ï–û–ë–•–û–î–ò–ú–´–ï –ë–ò–ë–õ–ò–û–¢–ï–ö–ò (–ó–ê–í–ò–°–ò–ú–û–°–¢–ò):
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Python –∏ —Å–ª–µ–¥—É—é—â–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:
#   - pandas
#   - openpyxl
#   - send2trash
#
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Ö –º–æ–∂–Ω–æ –∫–æ–º–∞–Ω–¥–æ–π: pip install pandas openpyxl send2trash
# ======================================================================

import pandas as pd
import numpy as np
import sys
import re
import warnings
from openpyxl.utils import get_column_letter
from datetime import timedelta
import glob
import os

# ======================================================================
#            ‚¨áÔ∏è –û–ë–©–ò–ï –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò –ù–ê–°–¢–†–û–ô–ö–ò ‚¨áÔ∏è
# ======================================================================

# –ü–∞–ø–∫–∞ —Å —Ñ–∞–π–ª–∞–º–∏
DIRECTORY = os.path.join(os.path.expanduser("~"), "Downloads")

# –ü–æ–¥–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ—Ç openpyxl
warnings.filterwarnings(
    "ignore",
    category=UserWarning,
    module="openpyxl.styles.stylesheet",
    message="Workbook contains no default style, apply openpyxl's default"
)

def find_files_to_process(directory, name_pattern, format=".xlsx"):
    """–ò—â–µ—Ç —Ñ–∞–π–ª—ã –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É, –∏—Å–∫–ª—é—á–∞—è —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ."""
    PROCESSED_TAG = "_–û–ë–†–ê–ë–û–¢–ê–ù–ù–´–ô"
    return [f for f in glob.glob(os.path.join(directory, f"{name_pattern}{format}"))
            if PROCESSED_TAG not in os.path.basename(f)]

def get_analysis_period():
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏ –≤—ã–≤–æ–¥–∏—Ç –≤ –∫–æ–Ω—Å–æ–ª—å –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º—ã–π –ø–µ—Ä–∏–æ–¥ (—Ç–µ–∫—É—â–∞—è –∏–ª–∏ –ø—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è).
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (analysis_start_date, analysis_end_date).
    """
    # –ü–æ–ª—É—á–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
    TODAY = pd.Timestamp.now().normalize()
    day_of_week = TODAY.weekday() # –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫=0, –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ=6
    
    # –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞
    if day_of_week in [5, 6]: # 5=—Å—É–±–±–æ—Ç–∞, 6=–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
        print(f"üöÄ –†–µ–∂–∏–º: {TODAY.day_name(locale='ru_RU')}. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¢–ï–ö–£–©–£–Æ –Ω–µ–¥–µ–ª—é.")
        # –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞: —ç—Ç–æ—Ç –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫. –ö–æ–Ω–µ—Ü: —Å–µ–≥–æ–¥–Ω—è.
        start_of_period = TODAY - timedelta(days=day_of_week)
        end_of_period = TODAY
        BUFFER_DAYS = 2     # –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = 2
    else:
        # –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –¥–Ω–µ–π –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ü–†–ï–î–´–î–£–©–£–Æ –ø–æ–ª–Ω—É—é –Ω–µ–¥–µ–ª—é
        print(f"üöÄ –†–µ–∂–∏–º: {TODAY.day_name(locale='ru_RU')}. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ü–†–ï–î–´–î–£–©–£–Æ –Ω–µ–¥–µ–ª—é.")
        # –ù–∞—á–∞–ª–æ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ (—ç—Ç–æ—Ç –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
        start_of_current_week = TODAY - timedelta(days=day_of_week)
        # –ö–æ–Ω–µ—Ü –ø—Ä–µ–¥—ã–¥—É—â–µ–π –Ω–µ–¥–µ–ª–∏ (–ø—Ä–æ—à–ª–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)
        end_of_period = start_of_current_week - timedelta(days=1)
        # –ù–∞—á–∞–ª–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –Ω–µ–¥–µ–ª–∏ (–ø—Ä–æ—à–ª—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
        start_of_period = end_of_period - timedelta(days=6)
        BUFFER_DAYS = 0     # –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é = 0
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –±—É—Ñ–µ—Ä –∫ –Ω–∞—á–∞–ª—å–Ω–æ–π –¥–∞—Ç–µ
    analysis_start_date = start_of_period - timedelta(days=BUFFER_DAYS)
    analysis_end_date = end_of_period
    
    print(f"üìÖ –û–∫–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç (—Å —É—á–µ—Ç–æ–º –±—É—Ñ–µ—Ä–∞): —Å {analysis_start_date.date()} –ø–æ {analysis_end_date.date()}")
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞—Ç—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –≤—ã–∑—ã–≤–∞—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
    return analysis_start_date, analysis_end_date
            
def auto_fit_excel_columns(worksheet, df):
    """–ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤."""
    for i, col in enumerate(df.columns, 1):
        width = max(df[col].astype(str).map(len).max(), len(col)) + 2
        if col in ("–¢–µ–º–∞", "–ù–∞–∑–≤–∞–Ω–∏–µ"):
            width /= 3 if col == "–¢–µ–º–∞" else 2
        worksheet.column_dimensions[get_column_letter(i)].width = width

# ======================================================================
#            ‚¨áÔ∏è –û–ë–†–ê–ë–û–¢–ö–ê –ü–û–£–†–û–ß–ù–´–• –û–¢–ß–ï–¢–û–í ‚¨áÔ∏è
# ======================================================================

def process_lesson_files(directory):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—É—Ä–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã (–î–ó) –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂ (success_count, error_count)
    """
    print("\n--- üöÄ –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ü–û–£–†–û–ß–ù–´–• –æ—Ç—á–µ—Ç–æ–≤ (–î–ó) ---")
        
    # --- 1. –ù–ê–°–¢–†–û–ô–ö–ò –ü–û–ò–°–ö–ê ---
    #NAME_PATTERN = "*–¥–∑*"
    FORMAT       = ".xlsx"
    
    # --- 2. –ü–û–ò–°–ö –§–ê–ô–õ–û–í –î–õ–Ø –û–ë–†–ê–ë–û–¢–ö–ò ---
    # –í—ã–∑—ã–≤–∞–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∏—Å–∫–∞
    files_to_process = find_files_to_process(DIRECTORY, "*", FORMAT)

    # –°—Ç—Ä–æ–≥–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (–ò—â–µ—Ç —Ç–æ–ª—å–∫–æ –¥–∑_ –∏–ª–∏ _–¥–∑)
    lesson_files = [f for f in files_to_process 
                    if os.path.splitext(os.path.basename(f))[0].lower().startswith("–¥–∑_") or 
                       os.path.splitext(os.path.basename(f))[0].lower().endswith("_–¥–∑")]
            
    files_to_process = lesson_files
    
    if not files_to_process:
        print(f"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —à–∞–±–ª–æ–Ω—É —Å—Ç—Ä–æ–≥–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ –ø–∞–ø–∫–µ '{DIRECTORY}'.")
        print("   –¢—Ä–µ–±—É–µ—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–æ–≤: –¥–∑_–ò–ú–Ø.xlsx –∏–ª–∏ –ò–ú–Ø_–¥–∑.xlsx")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º 0 —É—Å–ø–µ—Ö–æ–≤ –∏ 0 –æ—à–∏–±–æ–∫, —á—Ç–æ–±—ã –≥–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–¥–æ–ª–∂–∏–ª —Ä–∞–±–æ—Ç—É
        return 0, 0, []
    
    print(f"üîç –ù–∞–π–¥–µ–Ω–æ {len(files_to_process)} —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:")
    for f in files_to_process:
        print(f"  - {os.path.basename(f)}")
    
    # --- 3. –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ –û–ë–†–ê–ë–û–¢–ö–ò ---
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –¥–ª—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞
    success_count = 0
    error_count = 0
    error_files = []
    success_files = []
    
    # –í–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –î–ó
    for input_file in files_to_process:
        
        # –°–æ–∑–¥–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        base_name = os.path.basename(input_file)
        name_without_ext = os.path.splitext(base_name)[0]
        output_file = os.path.join(DIRECTORY, f"{name_without_ext}_–û–ë–†–ê–ë–û–¢–ê–ù–ù–´–ô{FORMAT}")
    
        print(f"\n--- üîÑ –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É: {base_name} ---")
        
        # 4. –ß–¢–ï–ù–ò–ï –ò –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–•
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–∞–∫ Excel-—Ñ–∞–π–ª. –ï—Å–ª–∏ CSV, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pd.read_csv(input_file)
            df = pd.read_excel(input_file)
        except FileNotFoundError:
            print(f"‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: {input_file}")
            error_count += 1
            error_files.append(base_name)
            continue
        except Exception as e:
            print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª {input_file}. –û—à–∏–±–∫–∞: {e}")
            error_count += 1
            error_files.append(base_name)
            continue
        
        # --- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞—Ç –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–∫–Ω–∞ –∞–Ω–∞–ª–∏–∑–∞ ---
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–æ–ª–±—Ü—ã —Å –¥–∞—Ç–∞–º–∏ –≤ —Ñ–æ—Ä–º–∞—Ç datetime –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏–π.
        df['–î–∞—Ç–∞ —É—Ä–æ–∫–∞'] = pd.to_datetime(df['–î–∞—Ç–∞ —É—Ä–æ–∫–∞'], errors='coerce')
        df['–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á (–æ–±—è–∑)'] = pd.to_datetime(df['–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á (–æ–±—è–∑)'], errors='coerce')
        
        # –í—ã–∑—ã–≤–∞–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞—Ç
        analysis_start_date, analysis_end_date = get_analysis_period()
        
        # 5. –û–ß–ò–°–¢–ö–ê –ò –¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–Ø –î–ê–ù–ù–´–•
        # --- –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ---
        df["–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞"] = ("‚Ä¢ " +
            df["–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞"].astype(str).str.replace(
                r"\b–®–∫–æ–ª—å–Ω(?:–∞—è|—ã–π|–æ–µ)\s+|\..*", "", regex=True, flags=re.IGNORECASE
            ).str.strip().str.capitalize() + ", "
        )
        
        lesson_num = pd.to_numeric(df["–£—Ä–æ–∫(–õ–ö)"], errors="coerce")
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —É—Ä–æ–∫–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        df["_lesson_num_sort"] = lesson_num
        df["–£—Ä–æ–∫(–õ–ö)"] = np.where(lesson_num > 0, "—É—Ä–æ–∫ ‚Ññ" + lesson_num.astype(int).astype(str) + " ‚Äì", pd.NA)
        # –ó–∞–ø–∞—Å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:
        # df["–£—Ä–æ–∫(–õ–ö)"] = np.where(lesson_num > 0, "—É—Ä–æ–∫ ‚Ññ" + lesson_num.astype(int).astype(str) + " –ø–æ —Ç–µ–º–µ ¬´" + df["–¢–µ–º–∞"].astype(str) + "¬ª ‚Äì", pd.NA)
        # df["–£—Ä–æ–∫(–õ–ö)"] = np.where(lesson_num > 0, "—É—Ä–æ–∫" + " –ø–æ —Ç–µ–º–µ ¬´" + df["–¢–µ–º–∞"].astype(str) + "¬ª ‚Äì", pd.NA)
        df.dropna(subset=["–£—Ä–æ–∫(–õ–ö)"], inplace=True)
        
        # --- –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ ---"
        view_status = np.select(
            [df["–ü—Ä–æ—Å–º–æ—Ç—Ä –æ–Ω–ª–∞–π–Ω"] == "–¥–∞", df["–ü—Ä–æ—Å–º–æ—Ç—Ä –≤–∏–¥–µ–æ"] == "–¥–∞"],
            ["–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω –æ–Ω–ª–∞–π–Ω", "–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–∞ –∑–∞–ø–∏—Å—å"],
            default="–Ω–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω"
        )
        
        # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ä–µ—à–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
        def parse_tasks_from_string(task_series):
            """–ü–∞—Ä—Å–∏—Ç —Å–µ—Ä–∏—é pandas –≤–∏–¥–∞ 'X –∏–∑ Y' –≤ DataFrame —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏ 'solved' –∏ 'total'."""
            tasks_df = task_series.astype(str).str.extract(r"(\d+)\s+–∏–∑\s+(\d+)").apply(pd.to_numeric)
            tasks_df.columns = ["solved", "total"]
            # –ó–∞–º–µ–Ω—è–µ–º 0 –Ω–∞ NaN –≤ 'total', —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å
            tasks_df["total"] = tasks_df["total"].replace(0, np.nan)
            return tasks_df
        
        # --- –°—Ç–∞—Ç—É—Å –î–ó (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å) ---
        tasks_obyaz = parse_tasks_from_string(df["–†–µ—à–µ–Ω–æ –∑–∞–¥–∞—á (–æ–±—è–∑)"])
        is_homework_completed = (
            #(tasks_obyaz["solved"] == tasks_obyaz["total"]) | # –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –∏–ª–∏
            #(tasks_obyaz["total"] - tasks_obyaz["solved"] == 1) | # –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –≤—Å–µ–≥–æ 1 –∑–∞–¥–∞–Ω–∏–µ (–õ–ò–®–ù–ï–ï –ø—Ä–∏ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ –æ—Ç 0.5)
            ((tasks_obyaz["solved"] / tasks_obyaz["total"]) >= 0.5) # –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –Ω–µ –º–µ–Ω–µ–µ 50%
        ).fillna(False)
        homework_status = np.select(
            [is_homework_completed, tasks_obyaz["solved"] == 0],
            [" –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –î–ó —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º", " –∏ –Ω–µ —Å–¥–µ–ª–∞–Ω–æ –î–ó;"],
            default=" –∏ —Å–¥–µ–ª–∞–Ω–∞ —á–∞—Å—Ç—å –î–ó;"
        )
        df["–ü—Ä–æ—Å–º–æ—Ç—Ä"] = np.char.add(view_status, homework_status)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        df["_is_hw_completed"] = is_homework_completed
        
        # --- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ ---
        # 1. –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–æ–ø. –∑–∞–¥–∞—á–∞–º, –∏—Å–ø–æ–ª—å–∑—É—è —Å—Ç–æ–ª–±–µ—Ü "–†–µ—à–µ–Ω–æ –∑–∞–¥–∞—á (–¥–æ–ø)"
        tasks_dop = parse_tasks_from_string(df["–†–µ—à–µ–Ω–æ –∑–∞–¥–∞—á (–¥–æ–ø)"])
        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ: —Ä–µ—à–µ–Ω–æ >= 50% –¥–æ–ø. –∑–∞–¥–∞—á
        is_dop_sufficient = (tasks_dop["solved"] / tasks_dop["total"] >= 0.5).fillna(False)
        # 3. –ü—Ä–∏–≤–æ–¥–∏–º —Å—Ç–æ–ª–±—Ü—ã —Å —É—Å–ø–µ—à–Ω–æ—Å—Ç—å—é –∫ —á–∏—Å–ª–æ–≤–æ–º—É —Ç–∏–ø—É –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        uspeshnost_obyaz = pd.to_numeric(df["–£—Å–ø–µ—à–Ω–æ—Å—Ç—å (–æ–±—è–∑)"], errors='coerce')
        uspeshnost_dop = pd.to_numeric(df["–£—Å–ø–µ—à–Ω–æ—Å—Ç—å (–¥–æ–ø)"], errors='coerce')
        uspeshnost_obshch = pd.to_numeric(df["–£—Å–ø–µ—à–Ω–æ—Å—Ç—å (–æ–±—â–∞—è)"], errors='coerce')
        # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ: —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –¥–æ–ø > —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ–±—è–∑
        is_dop_better = (uspeshnost_dop > uspeshnost_obyaz).fillna(False)
        # 5. –í—ã–±–∏—Ä–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        use_overall_success = is_dop_sufficient & is_dop_better
        final_success_values = np.where(use_overall_success, uspeshnost_obshch, uspeshnost_obyaz)
        
        # –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è DataFrame
        df["_sort_success"] = pd.Series(final_success_values, index=df.index).mul(100).round()
        
        # --- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–µ –∏ "–¥–æ–ª–≥–∞–º" ---
        # –°–æ–∑–¥–∞–µ–º —É—Å–ª–æ–≤–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:
        # 1. –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ —É—Ä–æ–∫—É –Ω–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º (—ç—Ç–æ "–¥–æ–ª–≥").
        is_debt = ~df['_is_hw_completed']
        # 2. –£—Ä–æ–∫ –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ —Ä–∞–º–∫–∞—Ö —Ä–∞—Å—á–µ—Ç–Ω–æ–≥–æ –æ–∫–Ω–∞.
        is_done_in_window = (
            (df['–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á (–æ–±—è–∑)'] >= analysis_start_date) &
            (df['–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á (–æ–±—è–∑)'] <= analysis_end_date)
        )
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä: –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ —ç—Ç–æ –¥–æ–ª–≥ –ò–õ–ò —É—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ –Ω—É–∂–Ω–æ–º –æ–∫–Ω–µ
        # .copy() –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è SettingWithCopyWarning
        df = df[is_debt | is_done_in_window].copy()
        
        # --- –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–π —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –ø–æ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞–º –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ ---
        # –°—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ —Ç–æ–ª—å–∫–æ –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º —Ä–∞–±–æ—Ç–∞–º, –∏–≥–Ω–æ—Ä–∏—Ä—É—è "–¥–æ–ª–≥–∏"
        score_for_avg = df['_sort_success'].where(df['_is_hw_completed'], np.nan)
        df['_discipline_avg_score'] = score_for_avg.groupby(df['–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞']).transform('mean')
        # –°–æ–∑–¥–∞–µ–º –∫–ª—é—á, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª —Ç–æ–ª—å–∫–æ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º —É—Ä–æ–∫–∞–º
        df['_sort_key_score'] = df['_discipline_avg_score'].where(df['_is_hw_completed'], -1)
        
        # --- –°–û–†–¢–ò–†–û–í–ö–ê --- 
        df.sort_values(
            by=["_is_hw_completed", "_sort_key_score", "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞", "_lesson_num_sort"],
            ascending=[False, False, True, True], # ‚Üì –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ/–ù–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ, ‚Üì –£—Å–ø–µ—à–Ω–æ—Å—Ç—å, ‚Üë –ù–∞–∑–≤–∞–Ω–∏–µ, ‚Üë –ù–æ–º–µ—Ä —É—Ä–æ–∫–∞
            na_position="last",
            inplace=True,
            ignore_index=True
        )
        
        # 6. –§–ò–ù–ê–õ–¨–ù–û–ï –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –£–°–ü–ï–®–ù–û–°–¢–ò
        success_col = df["_sort_success"]
        is_hw_done = df['_is_hw_completed']
        
        # –î–ª—è –í–°–ï–• –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç –ø–æ–∫–∞ —Å—Ç–∞–≤–∏–º "; "
        conditions = [
            success_col.isna(), # –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
            ~is_hw_done         # –ï—Å–ª–∏ –î–ó –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ (–¥–æ–ª–≥)
        ]
        choices = [
            "-", 
            ""
        ]
        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ) -> —Å—Ç–∞–≤–∏–º –ø—Ä–æ—Ü–µ–Ω—Ç –∏ —Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π
        default = success_col.astype('Int64').astype(str) + "%; "
        df["–£—Å–ø–µ—à–Ω–æ—Å—Ç—å"] = np.select(conditions, choices, default=default)
        
        # –¢–æ—á–µ—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
        if not df.empty:
            # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–°–õ–ï–î–ù–ï–ì–û –ü–†–û–¶–ï–ù–¢–ê (–£—Å–ø–µ—à–Ω–æ—Å—Ç—å)
            # –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ –î–ó –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –í–´–ü–û–õ–ù–ï–ù–û
            last_success_idx = df[df['_is_hw_completed']].index.max()
            # –ï—Å–ª–∏ —Ç–∞–∫–æ–π –∏–Ω–¥–µ–∫—Å –Ω–∞–π–¥–µ–Ω (–µ—Å—Ç—å —Ö–æ—Ç—å –æ–¥–Ω–∞ –æ—Ü–µ–Ω–∫–∞), –º–µ–Ω—è–µ–º ";" –Ω–∞ "."
            if pd.notna(last_success_idx):
                current_val = df.loc[last_success_idx, "–£—Å–ø–µ—à–Ω–æ—Å—Ç—å"]
                if isinstance(current_val, str):
                    df.loc[last_success_idx, "–£—Å–ø–µ—à–Ω–æ—Å—Ç—å"] = current_val.replace(' ;', '.').replace(';', '.')
            # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ù–¶–ê –¢–ê–ë–õ–ò–¶–´ (–ü—Ä–æ—Å–º–æ—Ç—Ä)
            # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
            last_row_idx = df.index[-1]
            current_view = df.loc[last_row_idx, "–ü—Ä–æ—Å–º–æ—Ç—Ä"]
            if isinstance(current_view, str):
                df.loc[last_row_idx, "–ü—Ä–æ—Å–º–æ—Ç—Ä"] = current_view.replace(' ;', '.').replace(';', '.')

        # 7. –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–ê
        # --- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ç–æ–ª–±—Ü–∞ —Å–æ —Å—Ä–µ–¥–Ω–∏–º –±–∞–ª–ª–æ–º ---
        # –°–æ–∑–¥–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã
        # –∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç.
        df['–°—Ä. –±–∞–ª–ª'] = np.where(
            df['_is_hw_completed'],
            df['_discipline_avg_score'].round(0).astype('Int64').astype(str) + '%',
            ' '  # –ü—É—Å—Ç–æ –¥–ª—è –¥–æ–ª–≥–æ–≤
        )
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ —Å—Ç—Ä–æ–∫–∏ —è–≤–ª—è—é—Ç—Å—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–º–∏—Å—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
        is_duplicated_discipline = (df['–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞'] == df['–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞'].shift(1))
        
        # –°–∫—Ä—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –¥–ª—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å—Ç—Ä–æ–∫ (—á–µ—Ä–µ–∑ Numpy)
        df["–°—Ä. –±–∞–ª–ª"] = np.where(is_duplicated_discipline, ' ', df["–°—Ä. –±–∞–ª–ª"])
        
        # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã –¥–ª—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å—Ç—Ä–æ–∫ (—á–µ—Ä–µ–∑ Pandas –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è ‚òª)
        df["–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞"] = df["–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞"].where(~is_duplicated_discipline, '\xa0\xa0\xa0')
        
        final_columns = [
            "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞", "–£—Ä–æ–∫(–õ–ö)", "–ü—Ä–æ—Å–º–æ—Ç—Ä", "–£—Å–ø–µ—à–Ω–æ—Å—Ç—å", 
            "–†–µ—à–µ–Ω–æ –∑–∞–¥–∞—á —Ä/–ø", "–°—Ä. –±–∞–ª–ª", "–†–µ—à–µ–Ω–æ –∑–∞–¥–∞—á (–æ–±—è–∑)",
            "–¢–µ–º–∞", "–î–∞—Ç–∞ —É—Ä–æ–∫–∞", "–ü–µ—Ä–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ", "–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á (–æ–±—è–∑)"
        ]
        # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–±–æ—Ä —Å—Ç–æ–ª–±—Ü–æ–≤, –¥–∞–∂–µ –µ—Å–ª–∏ –∫–∞–∫–∏—Ö-—Ç–æ –Ω–µ—Ç –≤ —Ñ–∞–π–ª–µ
        df = df[[col for col in final_columns if col in df.columns]]
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø—Ä–∏–≤—ã—á–Ω—ã–π –≤–∏–¥ –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ Excel
        df['–î–∞—Ç–∞ —É—Ä–æ–∫–∞'] = df['–î–∞—Ç–∞ —É—Ä–æ–∫–∞'].dt.strftime('%d.%m.%Y')
        
        try:
            with pd.ExcelWriter(output_file, engine='openpyxl') as writer:
                df.to_excel(writer, index=False, sheet_name='Report')

                # –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ª–∏—Å—Ç—É
                worksheet = writer.sheets['Report']
                # –í—ã–∑—ã–≤–∞–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –∞–≤—Ç–æ–ø–æ–¥–±–æ—Ä–∞ —à–∏—Ä–∏–Ω—ã
                auto_fit_excel_columns(worksheet, df)
                
            print("‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª:", output_file)
            success_count += 1
            success_files.append(input_file)
        
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ {output_file}: {e}")
            error_count += 1
            error_files.append(base_name)
            
    # --- –ö–û–ù–ï–¶ –¶–ò–ö–õ–ê FOR ---
    # --- 8. –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢ ---
    print("\n==============================================")
    print("üéâ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –î–ó –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
    print(f"‚úÖ  –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {success_count} –∏–∑ {len(files_to_process)}")
    print(f"‚ùå  –í–æ–∑–Ω–∏–∫–ª–æ –æ—à–∏–±–æ–∫:   {error_count}")
    
    if error_count > 0:
        print("\n‚ö†Ô∏è –§–∞–π–ª—ã, –≤—ã–∑–≤–∞–≤—à–∏–µ –æ—à–∏–±–∫—É:")
        for f_err in error_files:
            print(f"  - {f_err}")
    print("==============================================")
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
    return success_count, error_count, success_files

# ======================================================================
#           ‚¨áÔ∏è –û–ë–†–ê–ë–û–¢–ö–ê –û–¢–ß–ï–¢–û–í –ü–û –ü–†–û–í–ï–†–û–ß–ù–´–ú –†–ê–ë–û–¢–ê–ú ‚¨áÔ∏è
# ======================================================================

def process_test_files(directory):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã (–ü–†) –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂ (success_count, error_count)
    """
    print("\n--- üöÄ –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –ü–†–û–í–ï–†–û–ß–ù–´–ú —Ä–∞–±–æ—Ç–∞–º ---")
    
    # --- 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞ (–ü–†–û–í–ï–†–û–ß–ù–´–ï) ---
    #NAME_PATTERN = "*–ø—Ä*"
    FORMAT       = ".xlsx"
    
    # --- 2. –ü–û–ò–°–ö –§–ê–ô–õ–û–í ---
    # –í—ã–∑—ã–≤–∞–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∏—Å–∫–∞
    files_to_process = find_files_to_process(DIRECTORY, "*", FORMAT)
        
    # –°—Ç—Ä–æ–≥–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (–ò—â–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä_ –∏–ª–∏ _–ø—Ä)
    test_files = [f for f in files_to_process 
                  if os.path.splitext(os.path.basename(f))[0].lower().startswith("–ø—Ä_") or 
                     os.path.splitext(os.path.basename(f))[0].lower().endswith("_–ø—Ä")]
    
    files_to_process = test_files
        
    if not files_to_process:
        print(f"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —à–∞–±–ª–æ–Ω—É —Å—Ç—Ä–æ–≥–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ –ø–∞–ø–∫–µ '{DIRECTORY}'.")
        print("   –¢—Ä–µ–±—É–µ—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–æ–≤: –ø—Ä_–ò–ú–Ø.xlsx –∏–ª–∏ –ò–ú–Ø_–ø—Ä.xlsx")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º 0 —É—Å–ø–µ—Ö–æ–≤ –∏ 0 –æ—à–∏–±–æ–∫, —á—Ç–æ–±—ã –≥–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–¥–æ–ª–∂–∏–ª —Ä–∞–±–æ—Ç—É
        return 0, 0, []
        
    print(f"üîç –ù–∞–π–¥–µ–Ω–æ {len(files_to_process)} —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:")
    for f in files_to_process:
        print(f"  - {os.path.basename(f)}")

    # --- 3. –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ –û–ë–†–ê–ë–û–¢–ö–ò ---
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –¥–ª—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞
    success_count = 0
    error_count = 0
    error_files = []
    success_files = []
    
    # –í–µ—Å—å –∫–æ–¥ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–º–∏
    for input_file in files_to_process:
        
        # –°–æ–∑–¥–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        base_name = os.path.basename(input_file)
        name_without_ext = os.path.splitext(base_name)[0]
        output_file = os.path.join(DIRECTORY, f"{name_without_ext}_–û–ë–†–ê–ë–û–¢–ê–ù–ù–´–ô{FORMAT}")
    
        print(f"\n--- üîÑ –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É: {base_name} ---")
            
        # 4. –ß–¢–ï–ù–ò–ï –ò –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–•
        try:
            df = pd.read_excel(input_file)
        except FileNotFoundError:
            print(f"‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: {input_file}")
            error_count += 1
            error_files.append(base_name)
            continue # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç —Ñ–∞–π–ª, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
        except Exception as e:
            print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª {base_name}. –û—à–∏–±–∫–∞: {e}")
            error_count += 1
            error_files.append(base_name)
            continue # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç —Ñ–∞–π–ª, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
        
        # --- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É —Ä–∞–±–æ—Ç—ã ---
        # –ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –≤ —Å—Ç–æ–ª–±—Ü–µ 'lesson_name'
        keywords = '–ø—Ä–æ–≤–µ—Ä–æ—á–Ω–∞—è|–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è|–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π'
        df = df[df['lesson_name'].str.contains(keywords, case=False, na=False)].copy()
        
        # --- –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ ---
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã —Å—Ç—Ä–æ–∫–∏ —Å –æ—Ü–µ–Ω–∫–∞–º–∏ –æ–∫–∞–∑–∞–ª–∏—Å—å –≤—ã—à–µ –¥—É–±–ª–µ–π –±–µ–∑ –æ—Ü–µ–Ω–æ–∫
        df.sort_values(by=['lesson_id', '–û—Ü–µ–Ω–∫–∞'], ascending=[True, False], inplace=True)
        # –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ ID —É—Ä–æ–∫–∞, –æ—Å—Ç–∞–≤–ª—è—è –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å (—Ç—É, —á—Ç–æ —Å –æ—Ü–µ–Ω–∫–æ–π, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å)
        df.drop_duplicates(subset=['lesson_id'], keep='first', inplace=True)
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–æ–ª–±—Ü—ã —Å –¥–∞—Ç–∞–º–∏, –æ—à–∏–±–∫–∏ –ø—Ä–µ–≤—Ä–∞—Ç—è—Ç—Å—è –≤ NaT (Not a Time)
        df['lesson_date'] = pd.to_datetime(df['lesson_date'], errors='coerce')
        df['–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è'] = pd.to_datetime(df['–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è'], errors='coerce')
        
        # --- –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –û–ö–ù–ê –ê–ù–ê–õ–ò–ó–ê ---
        # –í—ã–∑—ã–≤–∞–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞—Ç
        analysis_start_date, analysis_end_date = get_analysis_period()
        
        # 5. –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –î–ê–ù–ù–´–•
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –ø–æ –≤—Å–µ–º—É —Å–ø–∏—Å–∫—É (—ç—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ "–¥–æ–ª–≥–æ–≤")
        _is_completed_full = (df['–û—Ü–µ–Ω–∫–∞'] > 0) & df['–û—Ü–µ–Ω–∫–∞'].notna()
        
        # --- –£—Å–ª–æ–≤–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ ---
        # 1. "–î–æ–ª–≥": —Ä–∞–±–æ—Ç–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ (–∑–∞ –≤—Å–µ –≤—Ä–µ–º—è)
        is_debt = ~_is_completed_full
        # 2. "–ù–µ–¥–∞–≤–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞": —Ä–∞–±–æ—Ç–∞ –±—ã–ª–∞ —Å–¥–∞–Ω–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7-9 –¥–Ω–µ–π (—Å —É—á–µ—Ç–æ–º –±—É—Ñ–µ—Ä–∞)
        is_done_in_window = (
            (df['–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è'] >= analysis_start_date) &
            (df['–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è'] <= analysis_end_date) &
            _is_completed_full
        )

        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä: –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏, –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Ö–æ—Ç—è –±—ã –ø–æ–¥ –æ–¥–Ω–æ —É—Å–ª–æ–≤–∏–µ
        df = df[is_debt | is_done_in_window].copy()
        
        # 6. –¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–Ø –ò –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï
        # –¢–µ–ø–µ—Ä—å –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã —É–∂–µ –≤ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
        is_completed = (df['–û—Ü–µ–Ω–∫–∞'] > 0) & df['–û—Ü–µ–Ω–∫–∞'].notna()
        # –ï—Å–ª–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –µ—Å—Ç—å "–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π" (–≤–∞—Ä–∏–∞–Ω—Ç), —Ç–æ —ç—Ç–æ –º—É–∂—Å–∫–æ–π —Ä–æ–¥
        is_masculine = df['lesson_name'].str.contains('–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π', case=False, na=False)
        # –£–±–∏—Ä–∞–µ–º –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞
        df['–ù–∞–∑–≤–∞–Ω–∏–µ'] = np.where(
            is_masculine,
            "‚àô " + df['lesson_name'].str.replace(r'\s+–¥–ª—è\s+\d+\s+–∫–ª–∞—Å—Å–∞', '', regex=True),
            "‚Ä¢ " + df['lesson_name'].str.replace(r'\s+–¥–ª—è\s+\d+\s+–∫–ª–∞—Å—Å–∞', '', regex=True),
        )   
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å —Å —É—á–µ—Ç–æ–º —Ä–æ–¥–∞ 
        status_conditions = [
            is_completed & is_masculine,   # –í—ã–ø–æ–ª–Ω–µ–Ω (–º—É–∂)
            is_completed & ~is_masculine,  # –í—ã–ø–æ–ª–Ω–µ–Ω–∞ (–∂–µ–Ω)
            ~is_completed & is_masculine,  # –ù–µ —Å–¥–µ–ª–∞–Ω (–º—É–∂)
            ~is_completed & ~is_masculine  # –ù–µ —Å–¥–µ–ª–∞–Ω–∞ (–∂–µ–Ω)
        ]
        status_choices = ['–≤—ã–ø–æ–ª–Ω–µ–Ω –Ω–∞ –æ—Ü–µ–Ω–∫—É',
            '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ –æ—Ü–µ–Ω–∫—É',
            '–Ω–µ —Å–¥–µ–ª–∞–Ω;',
            '–Ω–µ —Å–¥–µ–ª–∞–Ω–∞;']
        # –°–æ–∑–¥–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º: –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∏–ª–∏ –Ω–µ—Ç
        df['–°—Ç–∞—Ç—É—Å'] = np.select(status_conditions, status_choices, default='–Ω–µ —Å–¥–µ–ª–∞–Ω–∞;')
        # –ü–µ—Ä–µ–≤–æ–¥–∏–º –¥–æ–ª—é –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É
        percentage = (df['% –Ω–∞–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤'] * 100).round().astype('Int64')
        df['–†–µ–∑—É–ª—å—Ç–∞—Ç'] = np.where(
            is_completed,
            '(' + percentage.astype(str) + '%);',
            '')
        # –î–ª—è –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç –∑–∞–º–µ–Ω—è–µ–º –æ—Ü–µ–Ω–∫—É "0" –Ω–∞ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
        df['–û—Ü–µ–Ω–∫–∞'] = df['–û—Ü–µ–Ω–∫–∞'].astype(object) # –ú–µ–Ω—è–µ–º —Ç–∏–ø —Å—Ç–æ–ª–±—Ü–∞, —á—Ç–æ–±—ã —Ö—Ä–∞–Ω–∏—Ç—å –∏ —á–∏—Å–ª–∞, –∏ —Ç–µ–∫—Å—Ç
        df.loc[~is_completed, '–û—Ü–µ–Ω–∫–∞'] = ''
        
        # 7. –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–û–†–¢–ò–†–û–í–ö–ê
        # –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (True –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö, False –¥–ª—è "–¥–æ–ª–≥–æ–≤")
        df['is_completed_temp_col'] = is_completed
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º:
        df.sort_values(
            by=['is_completed_temp_col', '% –Ω–∞–±—Ä–∞–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤', '–ù–∞–∑–≤–∞–Ω–∏–µ', 'lesson_number'],
            ascending=[False, False, False, True], # ‚Üì –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ/–ù–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ, ‚Üì –£—Å–ø–µ—à–Ω–æ—Å—Ç—å, ‚Üì –ù–∞–∑–≤–∞–Ω–∏–µ, ‚Üë –ù–æ–º–µ—Ä —É—Ä–æ–∫–∞
            inplace=True
        )
        
        # 8. –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –ò–¢–û–ì–û–í–û–ì–û –û–¢–ß–ï–¢–ê
        # –í—ã–±–∏—Ä–∞–µ–º –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
        final_df = df[[
            '–ù–∞–∑–≤–∞–Ω–∏–µ', '–°—Ç–∞—Ç—É—Å', '–û—Ü–µ–Ω–∫–∞', '–†–µ–∑—É–ª—å—Ç–∞—Ç', '–†–µ—à–µ–Ω–æ –∑–∞–¥–∞—á', 
            'course_name', 'lesson_date', '–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è'
        ]].copy()
        final_df.reset_index(drop=True, inplace=True)
                        
        # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
        if not final_df.empty:
            # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–°–õ–ï–î–ù–ï–ì–û –ü–†–û–¶–ï–ù–¢–ê (–†–µ–∑—É–ª—å—Ç–∞—Ç)
            # –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ –ü–† –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–¥–µ–ª–∞–Ω–∞
            valid_indices = final_df[final_df['–†–µ–∑—É–ª—å—Ç–∞—Ç'] != ''].index            # –ï—Å–ª–∏ —Ç–∞–∫–æ–π –∏–Ω–¥–µ–∫—Å –Ω–∞–π–¥–µ–Ω, –º–µ–Ω—è–µ–º ";" –Ω–∞ "."
            if not valid_indices.empty:
                # –ë–µ—Ä–µ–º —Å–∞–º—ã–π –ø–æ—Å–ª–µ–¥–Ω–∏–π –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–∞–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞)
                last_res_idx = valid_indices[-1]
                val_res = final_df.loc[last_res_idx, '–†–µ–∑—É–ª—å—Ç–∞—Ç']
                if isinstance(val_res, str):
                    final_df.loc[last_res_idx, "–†–µ–∑—É–ª—å—Ç–∞—Ç"] = val_res.replace(' ;', '.').replace(';', '.')
            # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ù–¶–ê –¢–ê–ë–õ–ò–¶–´ (–°—Ç–∞—Ç—É—Å)
            # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ
            last_row_idx = final_df.index[-1]
            val_stat = final_df.loc[last_row_idx, "–°—Ç–∞—Ç—É—Å"]
            if isinstance(val_stat, str):
                final_df.loc[last_row_idx, "–°—Ç–∞—Ç—É—Å"] = val_stat.replace(' ;', '.').replace(';', '.')
                
        # 9. –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–ê –ò –ê–í–¢–û–ü–û–î–ë–û–† –®–ò–†–ò–ù–´ –°–¢–û–õ–ë–¶–û–í
        try:
            with pd.ExcelWriter(output_file, engine='openpyxl') as writer:
                final_df.to_excel(writer, index=False, sheet_name='Report')
                
                # –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ª–∏—Å—Ç—É
                worksheet = writer.sheets['Report']
                # –í—ã–∑—ã–≤–∞–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –∞–≤—Ç–æ–ø–æ–¥–±–æ—Ä–∞ —à–∏—Ä–∏–Ω—ã
                auto_fit_excel_columns(worksheet, final_df)
        
            print(f"‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª: {output_file}")
            success_count += 1
            success_files.append(input_file)
        
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ {output_file}: {e}")
            error_count += 1
            error_files.append(base_name)
            
    # --- –ö–û–ù–ï–¶ –¶–ò–ö–õ–ê FOR ---
    # --- 10. –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢ ---
    print("\n==============================================")
    print("üéâ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –ü–† –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
    print(f"‚úÖ  –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {success_count} –∏–∑ {len(files_to_process)}")
    print(f"‚ùå  –í–æ–∑–Ω–∏–∫–ª–æ –æ—à–∏–±–æ–∫:   {error_count}")
    
    if error_count > 0:
        print("\n‚ö†Ô∏è –§–∞–π–ª—ã, –≤—ã–∑–≤–∞–≤—à–∏–µ –æ—à–∏–±–∫—É:")
        for f_err in error_files:
            print(f"  - {f_err}")
    print("==============================================")
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
    return success_count, error_count, success_files

# ======================================================================
#                      ‚¨áÔ∏è –ó–ê–ü–£–°–ö –û–ë–†–ê–ë–û–¢–ö–ò ‚¨áÔ∏è
# ======================================================================

# –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–æ–¥ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ñ–∞–π–ª–∞ –Ω–∞–ø—Ä—è–º—É—é
if __name__ == "__main__":
    
    # 0. –°–ø–∏—Å–æ–∫ –¥–ª—è —Å–±–æ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    files_to_delete = []
    # 1. –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ—É—Ä–æ—á–Ω—ã—Ö –∏ "–ª–æ–≤–∏–º" —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—É—Å–ø–µ—Ö, –æ—à–∏–±–∫–∏)
    lesson_success, lesson_errors, lesson_to_delete = process_lesson_files(DIRECTORY)
    files_to_delete.extend(lesson_to_delete)
    # 2. –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã—Ö –∏ "–ª–æ–≤–∏–º" —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—É—Å–ø–µ—Ö, –æ—à–∏–±–∫–∏)
    test_success, test_errors, test_to_delete = process_test_files(DIRECTORY)
    files_to_delete.extend(test_to_delete)
    # 3. –°—á–∏—Ç–∞–µ–º –æ–±—â–∏–π –∏—Ç–æ–≥
    total_success = lesson_success + test_success
    total_errors = lesson_errors + test_errors
    
    # 4. –£–¥–∞–ª—è–µ–º —Å—ã—Ä—ã–µ —Ñ–∞–π–ª—ã, –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –æ—à–∏–±–æ–∫
    try:
        from send2trash import send2trash
        use_bin = True
    except ImportError:
        use_bin = False
    
    if total_errors == 0 and files_to_delete:
        print("\nüßπ –û—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ, —É–¥–∞–ª—è—é –∏—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã...")
        
        for file_path in files_to_delete:
            if "_–û–ë–†–ê–ë–û–¢–ê–ù–ù–´–ô" not in file_path:
                try:
                    if use_bin:
                        send2trash(file_path)
                    else:
                        os.remove(file_path)
                    print(f"  üóëÔ∏è {os.path.basename(file_path)} —É–¥–∞–ª—ë–Ω")
                except Exception as e:
                    print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å {file_path}: {e}")
    elif total_errors == 0 and not files_to_delete:
        print("\nüßπ –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã, —É–¥–∞–ª—è—Ç—å –Ω–µ—á–µ–≥–æ.")
    else:
        print("\n‚ö†Ô∏è –ë—ã–ª–∏ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ, –∏—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.")
    
    # 5. –ü–µ—á–∞—Ç–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç
    print("\n\n==============================================")
    print("üéâüéâüéâ –û–ë–©–ò–ô –ò–¢–û–ì –†–ê–ë–û–¢–´ –°–ö–†–ò–ü–¢–ê üéâüéâüéâ")
    print("==============================================")
    print("    –û—Ç—á–µ—Ç—ã –ø–æ –î–ó (–ø–æ—É—Ä–æ—á–Ω—ã–µ):")
    print(f"        ‚úÖ –£—Å–ø–µ—à–Ω–æ: {lesson_success}")
    print(f"        ‚ùå –û—à–∏–±–∫–∏:  {lesson_errors}")
    print("\n    –û—Ç—á–µ—Ç—ã –ø–æ –ü–† (–ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–µ):")
    print(f"        ‚úÖ –£—Å–ø–µ—à–Ω–æ: {test_success}")
    print(f"        ‚ùå –û—à–∏–±–∫–∏:  {test_errors}")
    print("----------------------------------------------")
    print("    üìä –í–°–ï–ì–û –û–ë–†–ê–ë–û–¢–ê–ù–û –§–ê–ô–õ–û–í:")
    print(f"        ‚úÖ –£—Å–ø–µ—à–Ω–æ: {total_success}")
    print(f"        ‚ùå –û—à–∏–±–∫–∏:  {total_errors}")
    print("==============================================")
    
    #    –ë–õ–û–ö –ü–ê–£–ó–´ (—Ç–æ–ª—å–∫–æ –¥–ª—è EXE-—Ñ–∞–π–ª–∞)
    IS_FROZEN = hasattr(sys, 'frozen') or hasattr(sys, '_MEIPASS')
    print("\n–í—Å—è —Ä–∞–±–æ—Ç–∞ –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–í–ï–†–®–ï–ù–ê.")
    
    # –ü–∞—É–∑–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π EXE)
    if IS_FROZEN:
        try:
            input("–ù–∞–∂–º–∏—Ç–µ Enter, —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ.")
        except EOFError:
            pass
# ----------------------------------------
